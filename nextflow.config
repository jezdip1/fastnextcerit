/*
 *  nextflow.config  – platné pro běh na CERIT-SC K8s
 */

k8s {
  namespace           = 'jezdik-ns'
  storageClaimName    = 'pvc-seg'
  storageMountPath    = '/mnt/data'
  workDir             = '/mnt/data/work'
  launchDir           = '/mnt/data/launch'
  runAsUser           = 1000
  computeResourceType = 'Job'
  cpuLimits           = true
}

params {
  input_dir = '/mnt/data/input'
  license   = '/mnt/data/license.txt'
}

process {
  executor  = 'k8s'
  container = 'deepmi/fastsurfer:latest'
  cpus      = 2
  memory    = '12 GB'

  /*
   *  Zde nutně MUSÍ být entrypoint: [] – aby Nextflow
   *  neumisťoval /bin/bash jako první argument run_fastsurfer.sh
   */
  pod = [
    [ entrypoint: [] ],
    [ securityContext: [
        fsGroupChangePolicy:'OnRootMismatch',
        runAsUser:1000,
        runAsGroup:1000,
        fsGroup:1000,
        seccompProfile:[ type:'RuntimeDefault' ]
      ]
    ],
    [ automountServiceAccountToken:false ]
  ]

  /*
   *  GPU / CPU / paměť pro fastsurfer procesy
   */
  ext.k8s = [
    limits:   [ cpu:'2',   memory:'12Gi',          'nvidia.com/gpu':'1' ],
    requests: [ cpu:'2',   memory:'10Gi',          'nvidia.com/gpu':'1' ]
  ]
}

executor {
  queueSize = 30
}
