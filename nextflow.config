// nextflow.config

// ───────────────────────────────────────────────────────────────────────────────
// Kubernetes executor settings (unchanged)
k8s {
  namespace           = 'jezdik-ns'
  runAsUser           = 1000
  computeResourceType = 'Job'
  cpuLimits           = true
  storageClaimName    = 'pvc-seg'
  storageMountPath    = '/mnt/data'
  launchDir           = '/mnt/data/launch'
  workDir             = '/mnt/data/work'
}

executor {
  queueSize = 30
}

params {
  input_dir = '/mnt/data/input'
  license   = '/mnt/data/license.txt'
}

// ───────────────────────────────────────────────────────────────────────────────
// Default process settings (the “controller” pod)
process {
  executor  = 'k8s'
  container = 'cerit.io/nextflow/nextflow:24.04.4'
  memory    = '12 GB'
  cpus      = 1

  // ─────────────────────────────────────────────────────────────────────────────
  // All your FastSurfer jobs get the “gpujob” label.
  // Here we override just those, injecting the GPU request under .resources:
  withLabel: gpujob {
    container = 'jezdip1/fastsurfer-cerit:latest'

    // patch the K8s pod spec
    ext.k8s = [
      resources: [
        requests: [
          'nvidia.com/gpu': '1',
          cpu             : '2',
          memory          : '10Gi'
        ],
        limits: [
          'nvidia.com/gpu': '1',
          cpu             : '2',
          memory          : '12Gi'
        ]
      ],
      securityContext: [
        runAsNonRoot            : true,
        runAsUser               : 1000,
        allowPrivilegeEscalation: false,
        capabilities            : [ drop: ['ALL'] ],
        seccompProfile          : [ type: 'RuntimeDefault' ]
      ]
    ]
  }
}
