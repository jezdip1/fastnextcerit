// -------- kubernetes blok --------
k8s {
  namespace        = 'jezdik-ns'
  storageClaimName = 'pvc-seg'
  storageMountPath = '/mnt/data'
  workDir          = '/mnt/data/work'
  launchDir        = '/mnt/data/launch'
}

// -------- executor --------
executor {
  name      = 'k8s'
  queueSize = 2         // max. 2 pody najednou
}

// -------- společné nastavení procesů --------
process {
  executor = 'k8s'      
  cpus     = 1          // každý proces 1 CPU
  memory   = '8.GB'     // každý proces 8 GiB

  // PodSecurity: musíme mít runAsNonRoot, seccompProfile, drop capabilities, apod.
  pod = [
    securityContext: [
      runAsUser:            1000,
      runAsNonRoot:         true,
      allowPrivilegeEscalation: false,
      capabilities: [
        drop: ['ALL']
      ],
      seccompProfile: [
        type: 'RuntimeDefault'
      ]
    ],
    automountServiceAccountToken: false
  ]

  // --- pro GPU-joby (fastsurfer_seg) ---
  withLabel: gpujob {
    container = 'jezdip1/fastsurfer-cerit:latest'

    // explicitně přidáme requesty i limity v Kubernetes
    ext.k8s = [
      requests: [
        cpu:           '1',
        memory:        '8Gi',
        'nvidia.com/gpu': '1'
      ],
      limits: [
        cpu:           '1',
        memory:        '8Gi',
        'nvidia.com/gpu': '1'
      ]
    ]

    // a zároveň pojistka, že jich nepoběží víc než 2
    maxForks = 2
  }
}
