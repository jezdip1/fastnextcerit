nextflow.enable.dsl = 2

k8s {
    namespace           = 'jezdik-ns'
    runAsUser           = 1000
    computeResourceType = 'Job'
    cpuLimits           = true
    storageClaimName    = 'pvc-seg'
    storageMountPath    = '/mnt/data'
    launchDir           = '/mnt/data/launch'
    workDir             = '/mnt/data/work'
}

executor {
    queueSize = 30
}

params {
    input_dir = '/mnt/data/input'
    license   = '/mnt/data/license.txt'
}

process {
    executor = 'k8s'
    cpus     = 2
    memory   = '12 GB'

    // << tady přidávejte patch, který smaže ENTRYPOINT a přepíše args na Nextflow wrapper >> 
    podOptions = '''
spec:
  containers:
    - command: ["/bin/bash","-ue"]
      args: ["./.command.run"]
'''

    // společné securityContext pro všechny pody
    pod = [
      [ securityContext: [
          fsGroup             : 1,
          fsGroupChangePolicy : 'OnRootMismatch',
          runAsUser           : 1000,
          runAsGroup          : 1,
          seccompProfile      : [ type: 'RuntimeDefault' ]
      ] ],
      [ automountServiceAccountToken: false ]
    ]

    // pro GPU procesy doplň image a zdroje
    withLabel: gpujob {
      container = 'ghcr.io/jezdip1/fastsurfer:latest'
      ext.k8s = [
        requests: [ 'nvidia.com/gpu': '1', cpu: '2',  memory: '10Gi' ],
        limits  : [ 'nvidia.com/gpu': '1', cpu: '2',  memory: '12Gi' ]
      ]
    }
}
