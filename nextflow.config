// nextflow.config

k8s {
  namespace           = 'jezdik-ns'
  runAsUser           = 1000
  computeResourceType = 'Job'
  cpuLimits           = true
  storageClaimName    = 'pvc-seg'
  storageMountPath    = '/mnt/data'
  launchDir           = '/mnt/data/launch'
  workDir             = '/mnt/data/work'
}

executor {
  queueSize = 30
}

params {
  input_dir = '/mnt/data/input'
  license   = '/mnt/data/license.txt'
}

process {
  executor  = 'k8s'
  container = 'cerit.io/nextflow/nextflow:24.04.4'
  cpus      = 1
  memory    = '12 GB'

  withLabel: gpujob {
    container = 'jezdip1/fastsurfer-cerit:latest'
    cpus      = 2
    memory    = '12 GB'
    maxForks  = 1

    ext.k8s = [
      // Základní GPU požadavky
      requests: [ 'nvidia.com/gpu': '1', cpu: '2', memory: '10Gi' ],
      limits:   [ 'nvidia.com/gpu': '1', cpu: '2', memory: '12Gi' ],

      // nutné, aby to běželo v nvidia runtime
      runtimeClassName: 'nvidia',

      // uplatnění non-root securityContext
      securityContext: [
        runAsNonRoot:             true,
        runAsUser:                1000,
        allowPrivilegeEscalation: false,
        capabilities:             [ drop: ['ALL'] ],
        seccompProfile:           [ type: 'RuntimeDefault' ]
      ],

      // proměnné pro viditelnost GPU a nastavení threading
      env: [
        [ name: 'NVIDIA_VISIBLE_DEVICES', value: 'all' ],
        [ name: 'CUDA_VISIBLE_DEVICES',  value: '0'   ],
        [ name: 'OMP_NUM_THREADS',       value: '2'   ]
      ]
    ]
  }
}
