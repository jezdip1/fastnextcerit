//
// Kubernetes / PVC settings
//
k8s {
  namespace          = 'jezdik-ns'
  storageClaimName   = 'pvc-seg'
  storageMountPath   = '/mnt/data'
  workDir            = '/mnt/data/work'
}

executor {
  // throttle how many pods Nextflow will try to schedule at once
  queueSize = 4
}

params {
  input_dir = '/mnt/data/input'
  license   = '/mnt/data/license.txt'
  out_dir   = '/mnt/data/subjects'
}

process {
  executor = 'k8s'
  cpus     = 1
  memory   = '12 GB'

  pod = [
    // must run as non-root to satisfy cluster PodSecurityPolicy
    securityContext: [
      runAsNonRoot: true,
      runAsUser:   1000,
      fsGroup:     1000,
      seccompProfile: [ type: 'RuntimeDefault' ]
    ],
    // always opt out of mounting the default SA token
    automountServiceAccountToken: false
  ]

  //
  // Any process you label ‘gpujob’ will get our wrapped GPU image
  // and 1 GPU
  //
  withLabel: gpujob {
    container = 'jezdip1/fastsurfer-cerit:latest'
    ext.k8s   = [
      requests: [
        cpu:           '1',
        memory:        '12Gi',
        'nvidia.com/gpu': '1'
      ],
      limits: [
        cpu:           '1',
        memory:        '12Gi',
        'nvidia.com/gpu': '1'
      ]
    ]
  }
}
